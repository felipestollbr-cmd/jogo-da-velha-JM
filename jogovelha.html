<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <link rel="manifest" href="./manifest.json">
    <meta name="theme-color" content="#FB923C">
    <meta name="apple-mobile-web-app-capable" content="yes">
    
    <title>EduPlay Kids ü¶Å Panda & Le√£o</title>
    <meta name="description" content="Jogo da velha educativo e seguro para crian√ßas.">
    <meta property="og:title" content="EduPlay Kids ü¶Åüêº - O Reino dos Bichinhos">
    <meta property="og:description" content="Brinque online com seguran√ßa no Reino dos Bichinhos!">
    <meta property="og:image" content="https://cdn-icons-png.flaticon.com/512/3021/3021601.png">
    <meta property="og:type" content="website">

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Fredoka+One&family=Quicksand:wght@500;700&display=swap" rel="stylesheet">
    
    <style>
        * { touch-action: manipulation; -webkit-touch-callout: none; -webkit-user-select: none; user-select: none; -webkit-tap-highlight-color: transparent; }
        body { font-family: 'Quicksand', sans-serif; background: radial-gradient(circle, #FFF5F7 0%, #F0F9FF 100%); min-height: 100vh; overflow: hidden; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .titulo { font-family: 'Fredoka One', cursive; }
        .cell { transition: all 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        .cell.winner { background-color: #BBF7D0 !important; animation: bounce 0.6s infinite alternate; border: 4px solid #22c55e !important; }
        @keyframes bounce { from { transform: scale(1); } to { transform: scale(1.1); } }
        .btn-home { @apply fixed top-6 left-6 z-50 bg-white p-4 rounded-3xl shadow-lg border-b-4 border-gray-200 active:scale-90 active:border-b-0 transition-all text-3xl; }
        .ad-slot { @apply mt-6 w-full max-w-sm h-20 bg-white/50 rounded-2xl flex items-center justify-center border-2 border-dashed border-orange-200 text-orange-300 text-[10px] uppercase font-bold; }
        .loader { border: 3px solid #f3f3f3; border-top: 3px solid #FB923C; border-radius: 50%; width: 20px; height: 20px; animation: spin 1s linear infinite; display: inline-block; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

    <button id="back-to-home" onclick="location.reload()" class="hidden btn-home">üè†</button>

    <div id="menu" class="max-w-md w-full space-y-4 px-4 text-center">
        <h1 class="titulo text-6xl text-orange-400 mb-8 drop-shadow-sm">EduPlay</h1>
        <div onclick="startMode('local')" class="bg-white p-6 rounded-[40px] shadow-xl border-b-8 border-pink-100 cursor-pointer active:scale-95 transition-all">
            <span class="text-5xl">üë´</span>
            <h2 class="titulo text-2xl text-pink-500 mt-2 text-center">Dois Jogadores</h2>
        </div>
        <div onclick="startMode('ai')" class="bg-white p-6 rounded-[40px] shadow-xl border-b-8 border-blue-100 cursor-pointer active:scale-95 transition-all">
            <span class="text-5xl">ü§ñ</span>
            <h2 class="titulo text-2xl text-blue-500 mt-2 text-center">Contra o Rob√¥</h2>
        </div>
        <div onclick="startMode('online')" class="bg-white p-6 rounded-[40px] shadow-xl border-b-8 border-purple-100 cursor-pointer active:scale-95 transition-all">
            <span class="text-5xl">üåê</span>
            <h2 class="titulo text-2xl text-purple-500 mt-2 text-center">Jogar Online</h2>
        </div>
        <button id="install-btn" onclick="installApp()" class="hidden mt-6 bg-green-500 text-white px-8 py-3 rounded-full font-bold shadow-lg animate-bounce titulo">INSTALAR NO CELULAR üì±</button>
    </div>

    <div id="online-setup" class="hidden max-w-sm w-full bg-white p-8 rounded-[50px] shadow-2xl text-center space-y-6 mx-4">
        <h2 class="titulo text-3xl text-purple-600">Conex√£o M√°gica</h2>
        <div onclick="copyMyId()" class="bg-purple-50 p-4 rounded-3xl border-2 border-dashed border-purple-200 cursor-pointer active:scale-95 relative">
            <p class="text-xs text-purple-400 font-bold uppercase mb-2 text-center">Toque para copiar seu c√≥digo:</p>
            <div id="id-loading" class="flex flex-col items-center"><div class="loader"></div></div>
            <p id="my-id" class="hidden text-xl font-mono font-black text-purple-700 break-all uppercase italic text-center"></p>
            <span id="copy-toast" class="hidden absolute -top-8 left-1/2 -translate-x-1/2 bg-green-500 text-white text-xs px-3 py-1 rounded-full">Copiado! ‚úÖ</span>
        </div>
        <input id="peer-id-input" type="text" placeholder="Cole o c√≥digo do amigo" class="w-full px-6 py-4 rounded-full border-4 border-purple-100 outline-none text-center text-lg uppercase">
        <button id="connect-btn" onclick="connectToPeer()" class="w-full bg-purple-500 text-white titulo py-4 rounded-full shadow-[0_6px_0_#6b21a8] active:translate-y-1">CONECTAR!</button>
    </div>

    <div id="game-container" class="hidden flex flex-col items-center relative w-full px-4">
        <div id="chat-overlay" class="absolute top-20 w-full flex justify-center h-0 overflow-visible pointer-events-none"></div>
        <div class="text-center mb-6">
            <div class="bg-white px-8 py-2 rounded-full shadow-md border-4 border-orange-50 mb-2 inline-block">
                <p id="message" class="titulo text-xl text-gray-700 italic font-bold uppercase text-center">ü¶Å Jogando...</p>
            </div>
            <div id="score" class="titulo text-3xl text-orange-400 text-center">ü¶Å 0 - 0 üêº</div>
        </div>
        <div class="bg-white p-4 rounded-[55px] shadow-2xl border-b-[12px] border-gray-100">
            <div id="grid" class="grid grid-cols-3 gap-3"></div>
        </div>
        
        <div class="ad-slot">
            <p class="text-center">Espa√ßo Reservado para An√∫ncio<br>(AdSense H5 Games)</p>
        </div>
    </div>

    <script>
        let mode = '', board = Array(9).fill(''), currentPlayer = 'ü¶Å', mySymbol = 'ü¶Å', gameActive = true, scores = { 'ü¶Å': 0, 'üêº': 0 }, peer, conn;

        // PWA e Service Worker
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => { navigator.serviceWorker.register('./sw.js').catch(() => {}); });
        }

        let installPrompt;
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault(); installPrompt = e;
            document.getElementById('install-btn').classList.remove('hidden');
        });

        async function installApp() {
            if (!installPrompt) return;
            installPrompt.prompt();
            const { outcome } = await installPrompt.userChoice;
            if (outcome === 'accepted') document.getElementById('install-btn').classList.add('hidden');
            installPrompt = null;
        }

        function startMode(m) {
            mode = m;
            document.getElementById('menu').classList.add('hidden');
            document.getElementById('back-to-home').classList.remove('hidden');
            if (m === 'online') {
                document.getElementById('online-setup').classList.remove('hidden');
                setupPeer();
            } else { initGame(); }
        }

        function initGame() {
            document.getElementById('online-setup').classList.add('hidden');
            document.getElementById('game-container').classList.remove('hidden');
            const grid = document.getElementById('grid');
            grid.innerHTML = '';
            for(let i=0; i<9; i++) {
                grid.innerHTML += `<button onclick="handleMove(${i})" id="c${i}" class="cell w-20 h-20 md:w-28 md:h-28 bg-pink-50 rounded-[35px] flex items-center justify-center text-5xl shadow-inner border-b-4 border-pink-100"></button>`;
            }
            updateMessage();
        }

        function setupPeer() {
            if (peer) peer.destroy();
            peer = new Peer({
                config: {
                    'iceServers': [
                        { urls: 'stun:stun.l.google.com:19302' },
                        { urls: 'stun:stun1.l.google.com:19302' },
                        { urls: 'stun:stun.services.mozilla.com' },
                        { urls: 'turn:openrelay.metered.ca:80', username: 'openrelayproject', credential: 'openrelayproject' },
                        { urls: 'turn:openrelay.metered.ca:443', username: 'openrelayproject', credential: 'openrelayproject' }
                    ]
                }
            });
            peer.on('open', id => {
                document.getElementById('id-loading').classList.add('hidden');
                const idEl = document.getElementById('my-id');
                idEl.innerText = id; idEl.classList.remove('hidden');
            });
            peer.on('connection', c => { conn = c; mySymbol = 'üêº'; setupConnEvents(); initGame(); });
            peer.on('error', err => { if(err.type === 'network') setTimeout(setupPeer, 3000); });
        }

        function connectToPeer() {
            const t = document.getElementById('peer-id-input').value.trim();
            if (!t) return;
            document.getElementById('connect-btn').innerText = "CONECTANDO...";
            conn = peer.connect(t, { reliable: true });
            mySymbol = 'ü¶Å';
            conn.on('open', () => { setupConnEvents(); initGame(); });
            setTimeout(() => { if (!conn.open) { alert("Conex√£o falhou. Tente o 4G!"); location.reload(); } }, 10000);
        }

        function setupConnEvents() {
            conn.on('data', d => { if (d.type === 'move') executeMove(d.index); });
            conn.on('close', () => location.reload());
        }

        function handleMove(i) {
            if (!gameActive || board[i] !== '') return;
            if (mode === 'online' && currentPlayer !== mySymbol) return;
            executeMove(i);
            if (mode === 'online' && conn?.open) conn.send({ type: 'move', index: i });
            if (gameActive && mode === 'ai' && currentPlayer === 'üêº') setTimeout(aiMove, 600);
        }

        function executeMove(i) {
            board[i] = currentPlayer;
            const el = document.getElementById(`c${i}`);
            if (el) el.innerText = currentPlayer;
            if (checkWin()) endGame(false);
            else if (board.every(c => c !== '')) endGame(true);
            else { currentPlayer = currentPlayer === 'ü¶Å' ? 'üêº' : 'ü¶Å'; updateMessage(); }
        }

        function aiMove() {
            let empty = board.map((v, i) => v === '' ? i : null).filter(v => v !== null);
            if (empty.length > 0) executeMove(empty[Math.floor(Math.random() * empty.length)]);
        }

        function checkWin() {
            const wins = [[0,1,2],[3,4,5],[6,7,8],[0,3,6],[1,4,7],[2,5,8],[0,4,8],[2,4,6]];
            for (let s of wins) {
                if (board[s[0]] && board[s[0]] === board[s[1]] && board[s[0]] === board[s[2]]) {
                    s.forEach(idx => document.getElementById(`c${idx}`).classList.add('winner'));
                    return true;
                }
            } return false;
        }

        function endGame(draw) {
            gameActive = false;
            if (!draw) {
                scores[currentPlayer]++;
                document.getElementById('message').innerText = `${currentPlayer} Venceu!`;
                document.getElementById('score').innerText = `ü¶Å ${scores['ü¶Å']} - ${scores['üêº']} üêº`;
                confetti({ particleCount: 150, spread: 70 });
            } else { document.getElementById('message').innerText = "Empatou! üêæ"; }
            setTimeout(() => resetBoard(), 3000);
        }

        function resetBoard() {
            board = Array(9).fill(''); gameActive = true; currentPlayer = 'ü¶Å';
            document.querySelectorAll('.cell').forEach(c => { c.innerText = ''; c.classList.remove('winner'); });
            updateMessage();
        }

        function updateMessage() {
            let msg = document.getElementById('message');
            if (mode === 'online') msg.innerText = (currentPlayer === mySymbol) ? "Sua vez! ‚ú®" : "Aguardando amigo...";
            else msg.innerText = `Vez do ${currentPlayer}`;
        }

        function copyMyId() {
            const idText = document.getElementById('my-id').innerText;
            navigator.clipboard.writeText(idText).then(() => {
                const toast = document.getElementById('copy-toast');
                toast.classList.remove('hidden');
                setTimeout(() => toast.classList.add('hidden'), 2000);
            });
        }
    </script>
</body>
</html>
